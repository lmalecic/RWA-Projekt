@model UserViewModel
@{
    ViewData["Title"] = "Profile";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Profile Details</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Username</div>
                        <div id="Username" class="col-sm-8">@Model.Username</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">First Name</div>
                        <div id="FirstName" class="col-sm-8">@Model.FirstName</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Last Name</div>
                        <div id="LastName" class="col-sm-8">@Model.LastName</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Email</div>
                        <div id="Email" class="col-sm-8">@Model.Email</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 text-muted">Phone Number</div>
                        <div id="Phone" class="col-sm-8">@Model.Phone</div>
                    </div>
                </div>
                <div class="card-footer">
                    <button id="ajaxEdit" class="btn btn-primary">Edit Profile</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="AjaxEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update User Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm" method="put">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="UsernameInput" value="@Model.Username" />
                    <div class="mb-3">
                        <label for="FirstNameInput" class="form-label">First name</label>
                        <input id="FirstNameInput" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="LastNameInput" class="form-label">Last name</label>
                        <input id="LastNameInput" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="EmailInput" class="form-label">E-mail</label>
                        <input type="email" id="EmailInput" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="PhoneInput" class="form-label">Phone</label>
                        <input type="tel" id="PhoneInput" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="SaveProfileButton" type="button" class="btn btn-primary">Save profile</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refresh() {
            $.ajax({
                url: `/User/GetProfileData?id=${modelId}`,
                method: "GET"
            })
                .done((data) => {
                    $("#Username").text(data.username);
                    $("#FirstName").text(data.firstName);
                    $("#LastName").text(data.lastName);
                    $("#Email").text(data.email);
                    $("#Phone").text(data.phone);
                })
                .fail((jqXHR, textStatus, errorThrown) => {
                    console.error('Error:', errorThrown);
                    alert('Failed to refresh profile data. Please try again.');
                });
        }

        const modelId = "@Model.Id";
        const ajaxEditModalEl = $("#AjaxEditModal")[0];
        const ajaxEditModal = new bootstrap.Modal(ajaxEditModalEl);

        $("#ajaxEdit").click((e) => {
            e.preventDefault();

            const firstName = $("#FirstName").text().trim();
            const lastName = $("#LastName").text().trim();
            const email = $("#Email").text().trim();
            const phone = $("#Phone").text().trim();

            $("#FirstNameInput").val(firstName);
            $("#LastNameInput").val(lastName);
            $("#EmailInput").val(email);
            $("#PhoneInput").val(phone);

            ajaxEditModal.show();
        });

        $("#SaveProfileButton").click(() => {
            const profile = {
                id: modelId
            };

            // Only include fields that were changed (have a value in the input)
            const firstName = $("#FirstNameInput").val();
            const lastName = $("#LastNameInput").val();
            const email = $("#EmailInput").val();
            const phone = $("#PhoneInput").val();

            if (firstName) profile.firstName = firstName;
            if (lastName) profile.lastName = lastName;
            if (email) profile.email = email;
            if (phone) profile.phone = phone;

            $.ajax({
                url: `/User/SetProfileData?id=${modelId}`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(profile)
            })
            .done((response) => {
                if (response.error) {
                    console.error('Update failed:', response.error);
                    alert('Could not update profile: ' + response.error);
                    return;
                }
                ajaxEditModal.hide();
                refresh();
            })
            .fail((jqXHR, textStatus, errorThrown) => {
                console.error('Error Status:', textStatus);
                console.error('Error Thrown:', errorThrown);
                alert('Could not update profile. Please try again.');
            });
        });
    </script>
}